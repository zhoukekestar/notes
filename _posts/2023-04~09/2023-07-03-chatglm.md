---
layout: post
title:  "ChatGLM2-6B 部署测试验证"
date:  2023-07-03
tags: [note]
---

  使用阿里云机器，部署 ChatGLM2，并做一些简单的测试。

# 环境

### 操作系统：Ubuntu 20.04 64位

```sh
# uname -a
Linux iZuf6784qjryroz25m3xqeZ 5.4.0-137-generic #154-Ubuntu SMP Thu Jan 5 17:03:22 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux
```

### 环境安全

* 开启 22 端口的 `47.96.60.0/24` `118.31.243.0/24`
  * 根据你登录的 webshell 的提示来自行添加相关网络段
* 开启服务器的端口，比如 5000 或 8000

![image](https://github.com/zhoukekestar/notes/assets/7157346/3656cb67-4e5a-48dd-93fe-b69caa2827c7)


# 安装

* `git clone https://github.com/THUDM/ChatGLM2-6B.git`
* `cd ChatGLM2-6B`
* `pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`
  * 使用清华镜像进行加速安装

安装模型，（因为我是为了避免网络问题，已经提前下载好了），所以我手动做了处理

```sh

$ cd ChatGLM2-6B

// 在当前项目的根目录下，新建相关文件
$ mkdir ./THUDM
$ mkdir ./THUDM/chatglm2-6b

// 把我下载好的模型，复制到当前项目的 THUDM/chatglm2-6b 目录下
$ cp ../chatglm2-6b/* ./THUDM/chatglm2-6b
```

# 测试

```sh
$ python api.py
Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████| 7/7 [00:06<00:00,  1.09it/s]
INFO:     Started server process [9997]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
[2023-07-03 21:15:10] ", prompt:"你是一个专业的物流问题分析工具，将以下用户反馈，抽象为一个6个字内的短语：三天了，从贵阳到黔西都没有到", response:"'"物流缓慢"'"
INFO:     127.0.0.1:35162 - "POST / HTTP/1.1" 200 OK
```

测试

```sh

curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"prompt":"你好"}' \
  http://127.0.0.1:8000
```

![image](https://github.com/zhoukekestar/notes/assets/7157346/81685d80-6cd1-4699-a1b0-97967fdcdb91)


![image](https://github.com/zhoukekestar/notes/assets/7157346/594f2e03-4a4a-4302-8727-d9277b8e6f2d)
