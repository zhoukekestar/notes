---
layout: post
title:  "Rust Web å¼€å‘æŒ‡åŒ—"
date:  2022-12-06
tags: [note]
---


  å°è¯•ä½¿ç”¨ rust å¼€å‘ä¸€ä¸ªç®€å•çš„ web é¡µé¢ã€‚ä½¿ç”¨ [yew](https://yew.rs/docs/getting-started/build-a-sample-app) æ¡†æ¶ï¼Œåœ¨ Chrome è¿è¡Œ WebAssemblyï¼Œå¹¶èƒ½åœ¨ IE 11 ä¸Šé™çº§åˆ° JS è¿è¡Œã€‚

# ç¯å¢ƒå‡†å¤‡

- [rustã€rustupã€cargo](https://www.rust-lang.org/learn/get-started)
- `cago-generate`, [more detail](https://github.com/cargo-generate/cargo-generate)
   - `$ cargo install cargo-generate`
- `wasm-pack`, [more detail](https://rustwasm.github.io/wasm-pack/installer/)
   - `$curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh`
- `wasm2js`, [more detail](https://github.com/WebAssembly/binaryen)
   - `$ brew install binaryen `
   - é€Ÿåº¦ä¸è¡Œçš„è¯ï¼Œè‡ªè¡Œåˆ‡æ¢è‡³ ä¸­ç§‘å¤§ æˆ– æ¸…åŒ— çš„é•œåƒï¼Œæ¨èä¸­ç§‘å¤§

# åˆå§‹åŒ–

  å‚è€ƒ [Rust and WebAssembly](https://rustwasm.github.io/docs/book/game-of-life/hello-world.html) çš„ HelloWorld æ ·ä¾‹ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆå§‹åŒ–ï¼š

  `$ cargo generate --git https://github.com/rustwasm/wasm-pack-template`

  è¾“å…¥åç§°ï¼š`hello-rust-wasm`

  åˆå§‹åŒ–å®Œæˆåï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```shell
.
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ LICENSE_APACHE
â”œâ”€â”€ LICENSE_MIT
â”œâ”€â”€ README.md
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ lib.rs
â”‚   â””â”€â”€ utils.rs
â””â”€â”€ tests
    â””â”€â”€ web.rs

```

# ç¼–è¾‘é¡µé¢

  ç”±äº rust åˆå§‹åŒ–æ—¶ï¼Œæ˜¯æŒ‰æ¨¡å—åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥ä¸»è¦ä»£ç å†™åœ¨ `lib.rs`ä¸­ï¼ˆæ­£å¸¸åˆå§‹åŒ–ä¸ºå…¥å£ä¸º `main.rs`)ï¼Œå†ç”±å¤–éƒ¨ JS å¼•å…¥ä¹‹åï¼Œå¯åŠ¨æ‰§è¡Œã€‚
ä¸ºäº†æ›´è´´è¿‘å®é™…å¼€å‘ï¼Œæˆ‘ä»¬ä½¿ç”¨ [yew](https://yew.rs/docs/getting-started/build-a-sample-app) æ¡†æ¶è¿›è¡Œå¼€å‘ï¼Œæ•´ä½“ä»£ç å‚è€ƒå¦‚ä¸‹ï¼š

- æ·»åŠ  yew ä¾èµ–

```toml

[dependencies]

yew = { version = "0.20.0", features = ["csr"] }
```

- é¡µé¢å†…å®¹

```rust
mod utils;

use wasm_bindgen::prelude::*;
use yew::prelude::*;

#[wasm_bindgen]
extern {
    fn alert(s: &str);

    #[wasm_bindgen(js_namespace = console)]
    fn log(s: &str);
}

#[function_component]
fn App() -> Html {

    html! {
        <div>
            <h1>{"Hello Rust"}</h1>
        </div>
    }
}

#[wasm_bindgen]
pub fn start() {
    log("Hello Rust!");
    yew::Renderer::<App>::new().render();
}
```

- æµ‹è¯•æ„å»ºï¼ŒæˆåŠŸä¹‹åï¼Œä¼šäºæ ¹è·¯å¾„äº§ç”Ÿ `./pkg/*.js` å’Œ `./pkg/*.wasm`

```toml
 $ wasm-pack build
[INFO]: ğŸ¯  Checking for the Wasm target...
[INFO]: ğŸŒ€  Compiling to Wasm...
[INFO]: â¬‡ï¸  Installing wasm-bindgen...
[INFO]: found wasm-opt at "/opt/homebrew/bin/wasm-opt"
[INFO]: Optimizing wasm binaries with `wasm-opt`...
[INFO]: Optional fields missing from Cargo.toml: xxx
[INFO]: âœ¨   Done in 1.46s
[INFO]: ğŸ“¦   Your wasm pkg is ready to publish at xxx
$ tree ./pkg
./pkg
â”œâ”€â”€ README.md
â”œâ”€â”€ hello_rust_wasm.d.ts
â”œâ”€â”€ hello_rust_wasm.js
â”œâ”€â”€ hello_rust_wasm_bg.js
â”œâ”€â”€ hello_rust_wasm_bg.wasm
â”œâ”€â”€ hello_rust_wasm_bg.wasm.d.ts
â””â”€â”€ package.json

0 directories, 7 files
```

# æ¸²æŸ“é¡µé¢

  å‚è€ƒ [Rust and WebAssembly](https://rustwasm.github.io/docs/book/game-of-life/hello-world.html) ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨é¡¹ç›®ä¸‹åˆå§‹åŒ– web åº”ç”¨ã€‚

```shell
#  åˆå§‹åŒ–
$ npm init wasm-app www

$ cd www

# ä½¿ç”¨ä¸Šå±‚æˆ‘ä»¬åˆšåˆšæ„å»ºçš„ pkg äº§ç‰©ä½œä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡ä¾èµ–
# âš ï¸ æ­¤å¤„é˜¿é‡Œå†…éƒ¨åŒå­¦ä¸è¦ä½¿ç”¨ tnpm ç­‰ï¼Œå¿…é¡»ä½¿ç”¨ npmï¼Œå¦åˆ™æŒ‡å‘ä¼šæœ‰é—®é¢˜
$ npm install hello-rust-wasm@file:../pkg -S
```

  ä¿®æ”¹ `wwww/index.js`æ–‡ä»¶

```javascript
import * as wasm from "hello-rust-wasm";

wasm.start();
```

  å¯åŠ¨æµ‹è¯•å¹¶é¢„è§ˆï¼š

```shell
$ npm start
$ open http://localhost:8080
```

![image](https://user-images.githubusercontent.com/7157346/205856038-f999f7d0-996a-45b0-8d96-5f97c647def9.png)


# WASM å…¼å®¹ IE11

  å‚è€ƒ [wasm2js](https://rustwasm.github.io/wasm-bindgen/examples/wasm2js.html)ï¼Œå¯¹äºä¸æ”¯æŒ WebAssembly çš„æµè§ˆå™¨ï¼Œå¯ä»¥é€šè¿‡ `wasm2js` å·¥å…·å°† WebAssembly ç¼–è¯‘åˆ° JS è¿›è¡Œæ‰§è¡Œã€‚

```shell
# ä¸´æ—¶ç¼–è¯‘æ–‡ä»¶
$ wasm2js ./pkg/hello_rust_wasm_bg.wasm -o ./pkg/fallback-temp.wasm.js
$ cp ./pkg/hello_rust_wasm_bg.js ./pkg/fallback-temp.js

# ä¿®æ”¹å…¥å£å’Œå¼•ç”¨
$ sed 's/hello_rust_wasm_bg/fallback/g' pkg/fallback-temp.wasm.js > pkg/fallback.wasm.js
$ sed 's/hello_rust_wasm_bg.wasm/fallback.wasm.js/' pkg/fallback-temp.js > pkg/fallback.js

# äºæ˜¯ï¼Œå¯ä»¥å¾—åˆ° fallback åœ¨ IE11 çš„é™çº§é€»è¾‘ä»£ç 
$ tree ./pkg
./pkg
â”œâ”€â”€ README.md
â”œâ”€â”€ fallback-temp.js
â”œâ”€â”€ fallback-temp.wasm.js
â”œâ”€â”€ fallback.js
â”œâ”€â”€ fallback.wasm.js
....
â””â”€â”€ package.json
```

# æ¸²æŸ“å…¼å®¹ IE 11

æ·»åŠ ä¾èµ–

```javascript
$ cd www
$ npm i @babel/core @babel/preset-env babel-loader@8 -D
$ npm i core-js text-encoding -S
```

æ·»åŠ  `fallback.js`

```javascript
import * as wasm from "hello-rust-wasm/fallback.js";

wasm.start();
```

  æ·»åŠ  `polyfill.js`ï¼Œä¹Ÿå¯ä»¥å…ˆä½¿ç”¨ [https://polyfill.io/v3/url-builder/](https://polyfill.io/v3/url-builder/) æ¥åšç®€å•çš„ polyfill æµ‹è¯•ã€‚

```javascript
import "core-js/modules/es.promise.js";
import "core-js/modules/es.array.fill.js";
import "core-js/modules/es.math.imul.js";
import "core-js/modules/es.math.clz32.js";
import TextEncodingPolyfill from 'text-encoding';

if (typeof window['TextEncoder'] !== 'function') {
  window['TextEncoder'] = TextEncodingPolyfill.TextEncoder;
  window['TextDecoder'] = TextEncodingPolyfill.TextDecoder;
}
```

  ä¿®æ”¹ HTML æ¨¡æ¿ï¼Œæ·»åŠ  polyfill ä¾èµ–ï¼Œå¹¶ä½¿å…¶é€‚é… fallback çš„é€»è¾‘

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello wasm-pack!</title>
  </head>
  <body>
    <script src="./polyfill.js"></script>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <script>
      if (typeof WebAssembly === 'object' && !/wasm=0/.test(location.href)) {
        document.write('<script src="./bootstrap.js"><\/script>');
      } else {
        document.write('<script src="./fallback.js"><\/script>');
      }
    </script>
  </body>
</html>
```

  ä¿®æ”¹ webpack æ‰“åŒ…é€»è¾‘

```javascript
const CopyWebpackPlugin = require('copy-webpack-plugin');
const path = require('path');

module.exports = {
  entry: {
    bootstrap: './bootstrap.js',
    fallback: './fallback.js',
    polyfill: './polyfill.js',
  },
  output: {
    path: path.resolve(__dirname, 'dist'),
  },
  module: {
    rules: [
      {
        test: /\.m?js$/,
        use: {
          loader: 'babel-loader',
          options: {
            presets: [
              [
                '@babel/preset-env',
                {
                  targets: { chrome: '50', ie: '11' },
                },
              ],
            ],
          },
        },
      },
    ],
  },
  plugins: [new CopyWebpackPlugin(['index.html'])]
};

```

  ä¸ºäº†æ–¹ä¾¿ä¸Šè¿°çš„å‘½ä»¤ä¸€æ¬¡æ€§æ‰§è¡Œï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ª `build.sh`æ–‡ä»¶

```shell
#!/bin/bash

# build WebAssembly
rm -rf ./pkg
wasm-pack build --release

# temp files
wasm2js ./pkg/hello_rust_wasm_bg.wasm -o ./pkg/fallback-temp.wasm.js
cp ./pkg/hello_rust_wasm_bg.js ./pkg/fallback-temp.js

sed 's/hello_rust_wasm_bg/fallback/g' pkg/fallback-temp.wasm.js > pkg/fallback.wasm.js
sed 's/hello_rust_wasm_bg.wasm/fallback.wasm.js/' pkg/fallback-temp.js > pkg/fallback.js

# build web app
cd www
rm -rf ./dist
npm run build
```

# æœ€ç»ˆæ•ˆæœ

  åœ¨çº¿é¢„è§ˆåœ°å€ï¼š[https://unpkg.com/hello-rust-wasm@0.2.0/dist/index.html](https://unpkg.com/hello-rust-wasm@0.2.0/dist/index.html)

  Chrome ä¸‹ä½¿ç”¨ wasm è¿è¡Œï¼ˆå½“ç„¶ï¼Œä½ å¯ä»¥åˆ¤æ–­ä¸€ä¸‹ç¯å¢ƒï¼Œæ¥ä¼˜åŒ–ä¸€ä¸‹ polyfill çš„åŠ è½½ï¼‰

  ![image](https://user-images.githubusercontent.com/7157346/205855927-9922f948-454c-4728-bbcf-3971a576c95a.png)

  IE 11 ä¸‹é™çº§åˆ° JS è¿è¡Œ

  ![image](https://user-images.githubusercontent.com/7157346/205855980-cc136356-706f-46e9-af84-3d7872513739.png)


# å°ç»“

  WebAssembly å¯ä»¥åœ¨ä¸šåŠ¡åœºæ™¯ä¸‹è¿›è¡Œå°è§„æ¨¡è¯•éªŒï¼Œç›®å‰åˆæ­¥å…·å¤‡æ•´ä½“çš„ç”Ÿæ€å·¥å…·é“¾ï¼ŒåŒ…æ‹¬ rust æ‰“åŒ…ã€WebAssembly æ‰“åŒ…ã€ä»¥åŠ wasm2js çš„é™çº§å…¼å®¹å¤„ç†ç­‰ç­‰ã€‚

  Rust ä½œä¸ºå‰ç«¯é¢†åŸŸæœ€å…·æœªæ¥æŠ•èµ„ä»·å€¼çš„è¯­è¨€ï¼Œå°†å‰ç«¯çš„ä¸Šé™åšäº†æå¤§çš„æå‡ã€‚ä¹Ÿå¸Œæœ›é€šè¿‡æœ¬æ–‡ï¼Œèƒ½å¼•èµ·æ›´å¤šå‰ç«¯åŒå­¦çš„å…³æ³¨å’Œå°è¯•ï¼Œå¼•å¯¼å‰ç«¯åšæ›´å¤šçš„ Rust å®è·µã€‚é€šè¿‡å®è·µï¼Œä¸€å®šéœ€è¦é€šè¿‡å®è·µï¼ˆè½åœ°ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼‰æ¥æ›´åŠ å¼ºåŠ›åœ°é©±åŠ¨ rust çš„è½åœ°ï¼ˆåŒ…æ‹¬ä½†ä¸é™äº [æ“ä½œç³»ç»Ÿ](https://github.com/torvalds/linux/tree/master/rust)ã€WebAppã€[WAVM](https://github.com/WAVM/WAVM) for non-Browserã€[WebContainer](https://github.com/stackblitz/webcontainer-core) for Desktop-Appã€[WebVM](https://leaningtech.com/webvm-server-less-x86-virtual-machines-in-the-browser/) for Serverless  ç­‰ç­‰ï¼‰ï¼Œå¹¶å®ç°è‡ªèº«æ›´å¹¿é˜”çš„èŒä¸šå‘å±•ç©ºé—´ã€‚

# å‚è€ƒ

- [Rust and WebAssembly](https://rustwasm.github.io/docs/book/)
- [wasm-pack installer](https://rustwasm.github.io/wasm-pack/installer/)
- [cargo-generate](https://github.com/cargo-generate/cargo-generate)
- [yew](https://yew.rs/docs/getting-started/build-a-sample-app)
- [wasm2js](https://rustwasm.github.io/wasm-bindgen/examples/wasm2js.html)
- [polyfill builder](https://polyfill.io/v3/url-builder/)
